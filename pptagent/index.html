<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒê° ì‹œê°í™”</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>AI ìƒê° ì‹œê°í™”</h1>
        
        <!-- onsubmit="return false" ì¶”ê°€í•˜ì—¬ ê¸°ë³¸ ì œì¶œ ë™ì‘ ì°¨ë‹¨ -->
        <div class="input-section">
            <form id="userInputForm" onsubmit="return false;">
                <textarea id="userInput" name="user_input" placeholder="ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”...">Please translate in Korean in ppt slide number 1.</textarea>
                <div class="checkbox-container">
                    <input type="checkbox" id="ruleBase" name="rule_base">
                    <label for="ruleBase">Rule Base Apply</label>
                </div>
                <button type="button" id="submitBtn">ì‹¤í–‰</button>
            </form>
        </div>
        
        <!-- ë””ë²„ê¹… ì„¹ì…˜ ì¶”ê°€ -->
        <div class="debug-section">
            <h3>ë””ë²„ê¹… ì •ë³´</h3>
            <pre id="debugOutput">ì¤€ë¹„ ì™„ë£Œ...</pre>
        </div>
        
        <!-- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ -->
        <div class="view-toggle">
            <button id="singleViewBtn" class="active">ë‹¨ê³„ë³„ ë³´ê¸°</button>
            <button id="expandViewBtn">ì „ì²´ í¼ì¹˜ê¸°</button>
        </div>
        
        <!-- ë‹¨ì¼ ë³´ë“œ ë·° -->
        <div id="singleBoardView" class="thinking-board active">
            <div class="board-header">
                <div class="step-icon" id="current-icon">ğŸ§ </div>
                <div class="step-title" id="current-title">ëŒ€ê¸° ì¤‘...</div>
                <div class="step-time" id="current-time"></div>
            </div>
            <div class="board-content">
                <div class="thinking-indicator" id="current-thinking">
                    <div class="dot dot1"></div>
                    <div class="dot dot2"></div>
                    <div class="dot dot3"></div>
                </div>
                <pre class="output" id="current-output"></pre>
            </div>
            
            <!-- ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
            <div class="progress-indicator">
                <div class="progress-step" data-step="planner">ê³„íš</div>
                <div class="progress-step" data-step="parser">ë¶„ì„</div>
                <div class="progress-step" data-step="processor">ì²˜ë¦¬</div>
                <div class="progress-step" data-step="applier">ì ìš©</div>
                <div class="progress-step" data-step="reporter">ë³´ê³ </div>
                <div class="progress-step" data-step="complete">ì™„ë£Œ</div>
            </div>
        </div>
        
        <!-- ì „ì²´ í¼ì¹˜ê¸° ë·° -->
        <div id="expandedView" class="thinking-container">
            <div class="thinking-step" id="planner">
                <div class="step-header">
                    <div class="step-icon">ğŸ§ </div>
                    <div class="step-title">ê³„íš ìˆ˜ë¦½</div>
                    <div class="step-time" id="planner-time"></div>
                </div>
                <div class="step-content">
                    <div class="thinking-indicator" id="planner-thinking">
                        <div class="dot dot1"></div>
                        <div class="dot dot2"></div>
                        <div class="dot dot3"></div>
                    </div>
                    <pre class="output" id="planner-output"></pre>
                </div>
            </div>
            
            <div class="thinking-step" id="parser">
                <div class="step-header">
                    <div class="step-icon">ğŸ“Š</div>
                    <div class="step-title">ê³„íš ë¶„ì„</div>
                    <div class="step-time" id="parser-time"></div>
                </div>
                <div class="step-content">
                    <div class="thinking-indicator" id="parser-thinking">
                        <div class="dot dot1"></div>
                        <div class="dot dot2"></div>
                        <div class="dot dot3"></div>
                    </div>
                    <pre class="output" id="parser-output"></pre>
                </div>
            </div>
            
            <div class="thinking-step" id="processor">
                <div class="step-header">
                    <div class="step-icon">âš™ï¸</div>
                    <div class="step-title">ì²˜ë¦¬</div>
                    <div class="step-time" id="processor-time"></div>
                </div>
                <div class="step-content">
                    <div class="thinking-indicator" id="processor-thinking">
                        <div class="dot dot1"></div>
                        <div class="dot dot2"></div>
                        <div class="dot dot3"></div>
                    </div>
                    <pre class="output" id="processor-output"></pre>
                </div>
            </div>
            
            <div class="thinking-step" id="applier">
                <div class="step-header">
                    <div class="step-icon">ğŸ”„</div>
                    <div class="step-title">ì ìš©</div>
                    <div class="step-time" id="applier-time"></div>
                </div>
                <div class="step-content">
                    <div class="thinking-indicator" id="applier-thinking">
                        <div class="dot dot1"></div>
                        <div class="dot dot2"></div>
                        <div class="dot dot3"></div>
                    </div>
                    <pre class="output" id="applier-output"></pre>
                </div>
            </div>
            
            <div class="thinking-step" id="reporter">
                <div class="step-header">
                    <div class="step-icon">ğŸ“</div>
                    <div class="step-title">ë³´ê³ ì„œ ì‘ì„±</div>
                    <div class="step-time" id="reporter-time"></div>
                </div>
                <div class="step-content">
                    <div class="thinking-indicator" id="reporter-thinking">
                        <div class="dot dot1"></div>
                        <div class="dot dot2"></div>
                        <div class="dot dot3"></div>
                    </div>
                    <pre class="output" id="reporter-output"></pre>
                </div>
            </div>
            
            <div class="thinking-step" id="final-result">
                <div class="step-header">
                    <div class="step-icon">âœ…</div>
                    <div class="step-title">ìµœì¢… ê²°ê³¼</div>
                    <div class="step-time" id="total-time"></div>
                </div>
                <div class="step-content">
                    <pre class="output" id="final-output"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í˜ì´ì§€ ë‚´ì— ì§ì ‘ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ë¡œë“œë¨!');
        
        // ë””ë²„ê¹… ì¶œë ¥ í•¨ìˆ˜
        function debug(message) {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.textContent += '\n' + message;
            console.log(message);
        }
        
        debug('ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™”...');
        
        // ìš”ì†Œ ì°¸ì¡°
        const userInput = document.getElementById('userInput');
        const ruleBase = document.getElementById('ruleBase');
        const submitBtn = document.getElementById('submitBtn');
        const singleViewBtn = document.getElementById('singleViewBtn');
        const expandViewBtn = document.getElementById('expandViewBtn');
        
        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        submitBtn.addEventListener('click', function() {
            debug('ì‹¤í–‰ ë²„íŠ¼ í´ë¦­ë¨!');
            
            const inputValue = userInput.value.trim();
            if (!inputValue) {
                alert('ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            debug(`ì…ë ¥ê°’: ${inputValue}`);
            debug(`ê·œì¹™ ê¸°ë°˜: ${ruleBase.checked}`);
            
            // í¼ ë°ì´í„° ì¤€ë¹„
            const formData = new FormData();
            formData.append('user_input', inputValue);
            formData.append('rule_base', ruleBase.checked);
            
            // ì²˜ë¦¬ ì¤‘ ìƒíƒœ í‘œì‹œ
            document.getElementById('current-icon').textContent = 'â³';
            document.getElementById('current-title').textContent = 'ìš”ì²­ ì²˜ë¦¬ ì¤‘...';
            document.getElementById('current-thinking').style.display = 'flex';
            
            // AJAX ìš”ì²­
            debug('ì„œë²„ì— ìš”ì²­ ë³´ë‚´ëŠ” ì¤‘...');
            fetch('/process', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                debug(`ì„œë²„ ì‘ë‹µ ìƒíƒœ: ${response.status}`);
                return response.json();
            })
            .then(data => {
                debug(`ì‘ë‹µ ë°ì´í„°: ${JSON.stringify(data)}`);
                
                if (data.status === 'processing') {
                    debug('í´ë§ ì‹œì‘...');
                    pollUpdates();
                } else {
                    debug(`ì˜¤ë¥˜: ${JSON.stringify(data)}`);
                    alert('ì˜¤ë¥˜: ' + JSON.stringify(data));
                }
            })
            .catch(error => {
                debug(`ì˜¤ë¥˜ ë°œìƒ: ${error}`);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        });
        
        // ë·° ì „í™˜ ë²„íŠ¼
        singleViewBtn.addEventListener('click', function() {
            debug('ë‹¨ê³„ë³„ ë³´ê¸° ì„ íƒ');
            singleViewBtn.classList.add('active');
            expandViewBtn.classList.remove('active');
            document.getElementById('singleBoardView').classList.add('active');
            document.getElementById('expandedView').classList.remove('active');
        });
        
        expandViewBtn.addEventListener('click', function() {
            debug('ì „ì²´ í¼ì¹˜ê¸° ì„ íƒ');
            expandViewBtn.classList.add('active');
            singleViewBtn.classList.remove('active');
            document.getElementById('expandedView').classList.add('active');
            document.getElementById('singleBoardView').classList.remove('active');
        });
        
        // ì—…ë°ì´íŠ¸ í´ë§ í•¨ìˆ˜
        function pollUpdates() {
            fetch('/thinking_updates')
                .then(response => response.json())
                .then(data => {
                    debug(`ì—…ë°ì´íŠ¸: ${JSON.stringify(data).substring(0, 100)}...`);
                    
                    // ê°ì¢… ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ë¡œì§
                    if (data.status === 'waiting') {
                        setTimeout(pollUpdates, 500);
                    } else if (data.status === 'finished') {
                        debug('ì²˜ë¦¬ ì™„ë£Œ');
                    } else if (data.status === 'error') {
                        debug(`ì˜¤ë¥˜: ${data.message}`);
                        alert('ì˜¤ë¥˜: ' + data.message);
                    } else {
                        // ë°ì´í„° ì²˜ë¦¬ (ì—¬ê¸°ì„œëŠ” ìƒëµ)
                        handleUpdate(data);
                        setTimeout(pollUpdates, 500);
                    }
                })
                .catch(error => {
                    debug(`í´ë§ ì˜¤ë¥˜: ${error}`);
                    setTimeout(pollUpdates, 1000);
                });
        }
        
        // ì—…ë°ì´íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
        function handleUpdate(data) {
            const step = data.step;
            const status = data.status;
            
            // í˜„ì¬ ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('current-icon').textContent = getStepIcon(step);
            document.getElementById('current-title').textContent = getStepTitle(step);
            
            // ì§„í–‰ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.progress-step').forEach(el => {
                if (el.dataset.step === step) {
                    el.classList.add('active');
                }
            });
            
            if (status === 'thinking') {
                document.getElementById('current-thinking').style.display = 'flex';
                document.getElementById('current-output').textContent = '';
            } else if (status === 'complete') {
                document.getElementById('current-thinking').style.display = 'none';
                
                if (data.data) {
                    let formattedData = typeof data.data === 'object' 
                        ? JSON.stringify(data.data, null, 2) 
                        : data.data;
                    
                    document.getElementById('current-output').textContent = formattedData;
                    document.getElementById('current-output').classList.add('visible');
                }
                
                if (data.time) {
                    document.getElementById('current-time').textContent = 
                        `ì†Œìš” ì‹œê°„: ${data.time.toFixed(2)}ì´ˆ`;
                }
            }
        }
        
        // ë‹¨ê³„ë³„ ì•„ì´ì½˜ ë°˜í™˜
        function getStepIcon(step) {
            const icons = {
                'planner': 'ğŸ§ ',
                'parser': 'ğŸ“Š',
                'processor': 'âš™ï¸',
                'applier': 'ğŸ”„',
                'reporter': 'ğŸ“',
                'complete': 'âœ…'
            };
            return icons[step] || 'â³';
        }
        
        // ë‹¨ê³„ë³„ ì œëª© ë°˜í™˜
        function getStepTitle(step) {
            const titles = {
                'planner': 'ê³„íš ìˆ˜ë¦½',
                'parser': 'ê³„íš ë¶„ì„',
                'processor': 'ì²˜ë¦¬',
                'applier': 'ì ìš©',
                'reporter': 'ë³´ê³ ì„œ ì‘ì„±',
                'complete': 'ìµœì¢… ê²°ê³¼'
            };
            return titles[step] || 'ì²˜ë¦¬ ì¤‘...';
        }
    });
    </script>
</body>
</html>